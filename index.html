<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Déposer — ContainerConnect</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --card:#122244;
      --text:#e8eefc; --muted:#a9b7d6; --line:rgba(255,255,255,.08);
      --accent:#4ea1ff; --buy:#38d6a6; --rent:#ffcc66; --danger:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:860px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .btn{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(78,161,255,.15); color:var(--text); cursor:pointer; }
    .btn:hover{ background:rgba(78,161,255,.22); }
    .btn-ghost{ padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); cursor:pointer; }
    .btn-ghost:hover{ background:rgba(255,255,255,.07); }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:14px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select, textarea{
      width:100%; padding:10px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.04); color:var(--text); outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .full{ grid-column:1 / -1; }
    .hint{ color:var(--muted); font-size:12px; margin-top:8px; }
    .err{ color:#ffb3b3; font-size:12px; margin-top:10px; display:none; }
    .preview{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .preview img{ width:110px; height:80px; object-fit:cover; border-radius:12px; border:1px solid rgba(255,255,255,.10); }
    @media (max-width: 760px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div style="font-weight:900; font-size:18px;">Déposer une annonce</div>
        <div style="color:var(--muted); font-size:12px;">Sauvegarde locale (localStorage) — en prod : Firestore/Storage</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn-ghost" id="btnBack">Retour</button>
        <button class="btn-ghost" id="btnProfile">Profil</button>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="kind">Type</label>
          <select id="kind">
            <option value="buy">Acheter</option>
            <option value="rent">Louer</option>
          </select>
        </div>

        <div id="periodWrap" style="display:none;">
          <label for="period">Période (location)</label>
          <select id="period">
            <option value="day">Jour</option>
            <option value="week">Semaine</option>
            <option value="month">Mois</option>
            <option value="year">Année</option>
          </select>
        </div>

        <div class="full">
          <label for="title">Titre</label>
          <input id="title" placeholder="ex: Conteneur 20ft — état neuf" />
        </div>

        <div>
          <label for="ctype">Type de conteneur</label>
          <select id="ctype">
            <option value="20ft">20ft</option>
            <option value="40ft">40ft</option>
            <option value="reefer">Reefer</option>
            <option value="open-top">Open-top</option>
          </select>
        </div>

        <div>
          <label for="cls">Classe</label>
          <select id="cls">
            <option value="A">A</option>
            <option value="B" selected>B</option>
            <option value="C">C</option>
          </select>
        </div>

        <div>
          <label for="city">Ville</label>
          <input id="city" placeholder="ex: Lyon" />
        </div>

        <div>
          <label for="price">Prix</label>
          <input id="price" type="number" min="0" step="1" placeholder="ex: 2200" />
        </div>

        <div>
          <label for="lat">Latitude</label>
          <input id="lat" type="number" step="0.000001" placeholder="ex: 45.7640" />
        </div>

        <div>
          <label for="lng">Longitude</label>
          <input id="lng" type="number" step="0.000001" placeholder="ex: 4.8357" />
        </div>

        <div class="full">
          <label for="tags">Tags (séparés par des virgules)</label>
          <input id="tags" placeholder="ex: stockage, chantier, accès 24/7" />
        </div>

        <div class="full">
          <label for="desc">Description</label>
          <textarea id="desc" placeholder="Décris l'annonce (état, lieu, disponibilité, livraison...)"></textarea>
        </div>

        <div class="full">
          <label for="photos">Photos (max 5)</label>
          <input id="photos" type="file" accept="image/*" multiple />
          <div class="hint">
            ⚠️ En local on stocke les images en “DataURL” dans localStorage → évite des photos trop lourdes.
          </div>
          <div class="preview" id="preview"></div>
        </div>

        <div class="full" style="display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
          <button class="btn-ghost" id="btnCancel">Annuler</button>
          <button class="btn" id="btnSave">Publier</button>
        </div>

        <div class="full err" id="errBox">—</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ✅ Remplace par TON firebaseConfig
    const firebaseConfig = {
      apiKey: "REMPLACE_MOI",
      authDomain: "REMPLACE_MOI",
      projectId: "REMPLACE_MOI",
      storageBucket: "REMPLACE_MOI",
      messagingSenderId: "REMPLACE_MOI",
      appId: "REMPLACE_MOI"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    function safeJsonParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }
    function setErr(msg){
      const el = document.getElementById("errBox");
      el.textContent = msg;
      el.style.display = "block";
    }
    function clearErr(){
      const el = document.getElementById("errBox");
      el.textContent = "";
      el.style.display = "none";
    }

    const kind = document.getElementById("kind");
    const periodWrap = document.getElementById("periodWrap");
    const period = document.getElementById("period");
    const title = document.getElementById("title");
    const ctype = document.getElementById("ctype");
    const cls = document.getElementById("cls");
    const city = document.getElementById("city");
    const price = document.getElementById("price");
    const lat = document.getElementById("lat");
    const lng = document.getElementById("lng");
    const tags = document.getElementById("tags");
    const desc = document.getElementById("desc");
    const photos = document.getElementById("photos");
    const preview = document.getElementById("preview");

    const btnSave = document.getElementById("btnSave");
    const btnCancel = document.getElementById("btnCancel");
    const btnBack = document.getElementById("btnBack");
    const btnProfile = document.getElementById("btnProfile");

    let currentUser = null;
    let photoDataUrls = [];

    function lsKeyListings(){ return "cc_user_listings_v1"; }
    function loadUserListings(){
      const arr = safeJsonParse(localStorage.getItem(lsKeyListings()));
      return Array.isArray(arr) ? arr : [];
    }
    function saveUserListings(arr){
      localStorage.setItem(lsKeyListings(), JSON.stringify(arr));
    }

    function newId(){
      return Math.floor(Date.now() / 1000) + Math.floor(Math.random()*1000);
    }

    function togglePeriod(){
      periodWrap.style.display = (kind.value === "rent") ? "block" : "none";
    }
    kind.addEventListener("change", togglePeriod);
    togglePeriod();

    photos.addEventListener("change", async () => {
      clearErr();
      photoDataUrls = [];
      preview.innerHTML = "";

      const files = Array.from(photos.files || []).slice(0,5);
      if (!files.length) return;

      for (const f of files){
        const dataUrl = await fileToDataUrl(f);
        photoDataUrls.push(dataUrl);

        const img = document.createElement("img");
        img.src = dataUrl;
        preview.appendChild(img);
      }
      if ((photos.files || []).length > 5){
        setErr("Tu as sélectionné plus de 5 photos : seules les 5 premières seront gardées.");
      }
    });

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    btnBack.addEventListener("click", () => window.location.href = "index.html");
    btnCancel.addEventListener("click", () => window.location.href = "index.html");
    btnProfile.addEventListener("click", () => window.location.href = "profile.html");

    btnSave.addEventListener("click", () => {
      clearErr();
      if (!currentUser){ setErr("Tu dois être connecté."); return; }

      const t = title.value.trim();
      const ci = city.value.trim();
      const pr = parseFloat(price.value);
      const la = parseFloat(lat.value);
      const ln = parseFloat(lng.value);

      if (!t) return setErr("Titre requis.");
      if (!ci) return setErr("Ville requise.");
      if (isNaN(pr) || pr < 0) return setErr("Prix invalide.");
      if (isNaN(la) || isNaN(ln)) return setErr("Latitude/Longitude requises (mets la position).");

      const tagArr = tags.value
        .split(",")
        .map(x => x.trim())
        .filter(Boolean)
        .slice(0,10);

      const item = {
        id: newId(),
        ownerUid: currentUser.uid,
        kind: kind.value,
        period: kind.value === "rent" ? period.value : null,
        class: cls.value,
        title: t,
        ctype: ctype.value,
        city: ci,
        price: Math.round(pr),
        lat: la,
        lng: ln,
        tags: tagArr,
        description: desc.value.trim(),
        contact: currentUser.email || "contact@local",
        photos: photoDataUrls.length ? photoDataUrls : []
      };

      const arr = loadUserListings();
      arr.push(item);
      saveUserListings(arr);

      // stats utilisateur (créations)
      const statsKey = `cc_stats_${currentUser.uid}`;
      const st = safeJsonParse(localStorage.getItem(statsKey)) || { created:0, buys:0, rents:0 };
      st.created += 1;
      if (item.kind === "buy") st.buys += 1; else st.rents += 1;
      localStorage.setItem(statsKey, JSON.stringify(st));

      window.location.href = "index.html";
    });

    onAuthStateChanged(auth, (u) => {
      currentUser = u || null;
      if (!currentUser){
        window.location.href = "auth.html?next=create.html";
      }
    });
  </script>
</body>
</html>
