<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ContainerConnect</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Top bar (en haut à droite sur la carte) -->
  <div class="topbar">
    <a class="profile-btn" href="auth.html" title="Se connecter / Profil">
      <span class="avatar" aria-hidden="true">
        <!-- petit buste (SVG) -->
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
          <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Z" stroke="currentColor" stroke-width="2"/>
          <path d="M4 20c1.6-3.5 5-5.5 8-5.5S18.4 16.5 20 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </span>
      <span class="profile-text">
        <span class="profile-title" id="authLabel">Se connecter</span>
        <span class="profile-sub" id="authSub">Google / Email</span>
      </span>
    </a>

    <a class="deposit-btn" href="create.html">Déposer</a>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge">CC</div>
        <div>
          <div class="brand-name">ContainerConnect</div>
          <div class="brand-sub">Achat & location de conteneurs — carte France</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="all">Tous</button>
        <button class="tab" data-tab="buy">Acheter</button>
        <button class="tab" data-tab="rent">Louer</button>
      </div>

      <div class="filters">
        <label class="field">
          <span>Type de conteneur</span>
          <select id="typeFilter">
            <option value="">Tous</option>
            <option value="20ft">20ft</option>
            <option value="40ft">40ft</option>
            <option value="stockage">Stockage</option>
            <option value="chantier">Chantier</option>
          </select>
        </label>

        <label class="field">
          <span>Prix max</span>
          <input id="priceMax" type="number" placeholder="ex: 2500" min="0"/>
        </label>

        <label class="field">
          <span>Ville / mot-clé</span>
          <input id="query" type="text" placeholder="ex: Lyon, stockage, chantier"/>
        </label>

        <div class="field row">
          <label class="field" style="flex:1;">
            <span>Rayon (km) autour du centre carte</span>
            <input id="radiusKm" type="number" placeholder="ex: 30" min="0"/>
          </label>
          <button class="chip" id="resetBtn" type="button">Reset</button>
        </div>
      </div>

      <div class="results-head">
        <span id="resultsCount">0 résultat(s)</span>
        <span class="muted" id="centerInfo">—</span>
      </div>

      <div class="cards" id="cards"></div>
    </aside>

    <!-- Map -->
    <main class="map-wrap">
      <div id="map"></div>
    </main>
  </div>

  <script>
    // --- Données DEMO (tu pourras remplacer par Firestore plus tard) ---
    const listings = [
      {
        id: "a1",
        title: "Conteneur 20ft — stockage sécurisé",
        mode: "buy",
        type: "20ft",
        city: "Paris",
        price: 2200,
        tags: ["stockage", "accès 24/7"],
        lat: 48.8566,
        lng: 2.3522
      },
      {
        id: "a2",
        title: "Location 40ft pour chantier (2 mois)",
        mode: "rent",
        type: "40ft",
        city: "Lille",
        price: 300,
        tags: ["chantier", "urgent"],
        lat: 50.6292,
        lng: 3.0573
      },
      {
        id: "a3",
        title: "Conteneur 20ft aménagé",
        mode: "buy",
        type: "20ft",
        city: "Lyon",
        price: 2900,
        tags: ["aménagé", "isolé"],
        lat: 45.7640,
        lng: 4.8357
      }
    ];

    // --- UI state ---
    let currentTab = "all";
    let markers = [];
    let map;

    function money(v, mode) {
      if (mode === "rent") return `${v} € / mois`;
      return `${v} €`;
    }

    function matchesFilters(item) {
      const type = document.getElementById("typeFilter").value.trim();
      const priceMax = Number(document.getElementById("priceMax").value);
      const q = document.getElementById("query").value.trim().toLowerCase();
      const radiusKm = Number(document.getElementById("radiusKm").value);

      if (currentTab !== "all" && item.mode !== currentTab) return false;
      if (type && item.type !== type) return false;
      if (!Number.isNaN(priceMax) && priceMax > 0 && item.price > priceMax) return false;

      if (q) {
        const hay = `${item.title} ${item.city} ${item.type} ${(item.tags||[]).join(" ")}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }

      if (!Number.isNaN(radiusKm) && radiusKm > 0 && map) {
        const center = map.getCenter();
        const d = map.distance([center.lat, center.lng], [item.lat, item.lng]) / 1000;
        if (d > radiusKm) return false;
      }

      return true;
    }

    function clearMarkers() {
      for (const m of markers) m.remove();
      markers = [];
    }

    function render(items) {
      const cards = document.getElementById("cards");
      cards.innerHTML = "";

      clearMarkers();

      const filtered = items.filter(matchesFilters);

      document.getElementById("resultsCount").textContent = `${filtered.length} résultat(s)`;
      if (map) {
        const c = map.getCenter();
        document.getElementById("centerInfo").textContent = `centre carte: ${c.lat.toFixed(2)}, ${c.lng.toFixed(2)}`;
      }

      for (const it of filtered) {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="card-top">
            <div class="pill">${it.mode === "rent" ? "Louer" : "Acheter"}</div>
            <div class="pill ghost">${it.type}</div>
            <div class="spacer"></div>
            <div class="price">${money(it.price, it.mode)}</div>
          </div>
          <div class="card-title">${it.title}</div>
          <div class="card-sub">${it.city}</div>
          <div class="tag-row">
            ${(it.tags||[]).slice(0,3).map(t => `<span class="tag">${t}</span>`).join("")}
          </div>
        `;

        card.addEventListener("click", () => {
          map.setView([it.lat, it.lng], 10, { animate: true });
        });

        cards.appendChild(card);

        const marker = L.marker([it.lat, it.lng]).addTo(map);
        marker.bindPopup(`<b>${it.title}</b><br>${it.city} — ${money(it.price, it.mode)}`);
        markers.push(marker);
      }
    }

    function initTabs() {
      document.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentTab = btn.dataset.tab;
          render(listings);
        });
      });
    }

    function initFilters() {
      ["typeFilter", "priceMax", "query", "radiusKm"].forEach(id => {
        document.getElementById(id).addEventListener("input", () => render(listings));
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        document.getElementById("typeFilter").value = "";
        document.getElementById("priceMax").value = "";
        document.getElementById("query").value = "";
        document.getElementById("radiusKm").value = "";
        render(listings);
      });
    }

    function initMap() {
      map = L.map("map", { zoomControl: true }).setView([46.56, 2.15], 6);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      map.on("moveend", () => render(listings));
      render(listings);
    }

    window.addEventListener("DOMContentLoaded", () => {
      initTabs();
      initFilters();

      // attendre Leaflet (chargé en defer)
      const t = setInterval(() => {
        if (window.L) {
          clearInterval(t);
          initMap();
        }
      }, 30);
    });
  </script>
</body>
</html>
